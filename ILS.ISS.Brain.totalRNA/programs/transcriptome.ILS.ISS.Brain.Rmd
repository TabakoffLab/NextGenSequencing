Compare Transcriptome-Guided Reconstructions Between BN-Lx and SHR
========================================================

Add "chr" to gtf file to be able to visualize in the UCSC genome browser
cd /Volumes/LauraS/LXS/RNA-Seq/totalRNA.24Oct13/reconstruction
awk '{if($1!~"ERCC") print "chr"$0}' ./ILS.total.ensemblGuided/transcripts.gtf > ./ILS.total.ensemblGuided/transcripts.forUCSC.gtf
awk '{if($1!~"ERCC") print "chr"$0}' ./ISS.total.ensemblGuided/transcripts.gtf > ./ISS.total.ensemblGuided/transcripts.forUCSC.gtf

1.  Import GTF files and limit transcripts to those that have FPKM>1 in at least on strain and are larger than 300 bp (not including introns)
--------------------------

```{r, eval=FALSE}
rm(list=ls())
options(stringsAsFactors=FALSE)
setwd("/Volumes/LauraS/LXS/RNA-Seq/totalRNA.24Oct13")

ILS <- read.table(file="reconstruction/ILS.total.ensemblGuided/transcripts.gtf",sep="\t",header=FALSE)
ILS$transcript_id = unlist(lapply(strsplit(ILS$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript_id",a)])))
ILS$gene_id = unlist(lapply(strsplit(ILS$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene_id",a)])))
ILS$fpkm = as.numeric(unlist(lapply(strsplit(ILS$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))

ILS.exons = ILS[ILS$V3=="exon",]
ILS.exons$length = ILS.exons$V5 - ILS.exons$V4 + 1

tmp = cbind(aggregate(ILS.exons$length,by=list(ILS.exons$transcript_id),sum),aggregate(ILS.exons$transcript_id,by=list(ILS.exons$transcript_id),length)$x)
colnames(tmp) = c("transcript_id","length","numExons")


ILS.transcripts = ILS[ILS$V3=="transcript",]
ILS.transcripts = merge(ILS.transcripts, tmp,by="transcript_id")
ILS.transcripts = ILS.transcripts[ILS.transcripts$fpkm!=0 & ILS.transcripts$length>300,]

## ISS ##
ISS <- read.table(file="reconstruction/ISS.total.ensemblGuided/transcripts.gtf",sep="\t",header=FALSE)
ISS$transcript_id = unlist(lapply(strsplit(ISS$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript_id",a)])))
ISS$gene_id = unlist(lapply(strsplit(ISS$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene_id",a)])))
ISS$fpkm = as.numeric(unlist(lapply(strsplit(ISS$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))

ISS.exons = ISS[ISS$V3=="exon",]
ISS.exons$length = ISS.exons$V5 - ISS.exons$V4 + 1

tmp = cbind(aggregate(ISS.exons$length,by=list(ISS.exons$transcript_id),sum),aggregate(ISS.exons$transcript_id,by=list(ISS.exons$transcript_id),length)$x)
colnames(tmp) = c("transcript_id","length","numExons")


ISS.transcripts = ISS[ISS$V3=="transcript",]
ISS.transcripts = merge(ISS.transcripts, tmp,by="transcript_id")
ISS.transcripts = ISS.transcripts[ISS.transcripts$fpkm!=0 & ISS.transcripts$length>300,]
save(ILS.transcripts,ISS.transcripts,ILS,ISS,file="Rdata/origRecon.Rdata")
```

```{r,echo=FALSE}
rm(list=ls())
options(stringsAsFactors=FALSE)
setwd("/Volumes/LauraS/LXS/RNA-Seq/totalRNA.24Oct13")
load("Rdata/origRecon.Rdata")
```

Comparison of Transcriptomes
----------------------------

* Number of Genes  
ILS = `r length(unique(ILS.transcripts$gene_id))`  
ISS = `r length(unique(ISS.transcripts$gene_id))`  

* Number of Transcripts  
ILS = `r nrow(ILS.transcripts)`  
ISS = `r nrow(ISS.transcripts)`  

* Average Number of Transcripts Per Gene  
ILS = `r nrow(ILS.transcripts)/length(unique(ILS.transcripts$gene_id))`  
ISS = `r nrow(ISS.transcripts)/length(unique(ISS.transcripts$gene_id))`  

* Max Number of Transcripts Per Gene  
ILS = `r max(table(ILS.transcripts$gene_id))`  
ISS = `r max(table(ISS.transcripts$gene_id))`  

* Number of RefSeq Genes Recovered    
ILS = `r sum(grepl("N",ILS.transcripts$transcript_id))`  
ISS = `r sum(grepl("N",ISS.transcripts$transcript_id))`  


2. Concatenate novel transcripts between strains, merge expressed RefSeq transcripts, and created BED File
--------------------------------------------------------------------------
```{r,eval=FALSE}

ILS.transcripts = ILS.transcripts[,c("transcript_id","gene_id","fpkm","length","numExons","V1","V4","V5")]
colnames(ILS.transcripts) = paste("ILS.",colnames(ILS.transcripts),sep="")

ISS.transcripts = ISS.transcripts[,c("transcript_id","gene_id","fpkm","length","numExons","V1","V4","V5")]
colnames(ISS.transcripts) = paste("ISS.",colnames(ISS.transcripts),sep="")

ILS.transcripts$transcript_id = gsub("CUFF","ILS",ILS.transcripts$ILS.transcript_id)
ISS.transcripts$transcript_id = gsub("CUFF","ISS",ISS.transcripts$ISS.transcript_id)

transcripts = merge(ISS.transcripts[ISS.transcripts$ISS.fpkm>1,],ILS.transcripts[ILS.transcripts$ILS.fpkm>1,],by="transcript_id",all=TRUE)

##  Convert to BED File  ##

ILS.v2 = ILS
ILS.v2$transcript_id = gsub("CUFF","ILS",ILS.v2$transcript_id)
ILS.v2$gene_id = gsub("CUFF","ILS",ILS.v2$gene_id)

ISS.v2 = ISS
ISS.v2$transcript_id = gsub("CUFF","ISS",ISS.v2$transcript_id)
ISS.v2$gene_id = gsub("CUFF","ISS",ISS.v2$gene_id)

combinedGTF = rbind(ILS.v2,ISS.v2)
combinedGTF = combinedGTF[,!(colnames(combinedGTF) %in% c("V9","fpkm"))]
combinedGTF = combinedGTF[!duplicated(combinedGTF),]
combinedGTF = combinedGTF[combinedGTF$transcript_id %in% transcripts$transcript_id,]

gtf <- combinedGTF[combinedGTF$V3=="exon",]
gtf <- gtf[order(gtf$transcript_id,gtf$V4,gtf$V5),]

print(paste("Number of Genes ",length(unique(gtf$gene_id)),sep=""))
print(paste("Number of Transcripts ",length(unique(gtf$transcript_id)),sep=""))

##  create one per transcript ##
start <- aggregate(gtf$V4,by=list(gtf$transcript_id),function(a) paste(a,collapse=","))
stop <- aggregate(gtf$V5,by=list(gtf$transcript_id),function(a) paste(a,collapse=","))
transcripts <- gtf[!duplicated(gtf[,c("transcript_id","V1")]),c("transcript_id","gene_id","V1","V6","V7")]
onePerTrans <- merge(start,stop,by=1)
onePerTrans <- merge(transcripts,onePerTrans,by=1)

onePerTrans$exonNum = unlist(lapply(strsplit(onePerTrans$x.x,split=",",fixed=TRUE),length))
onePerTrans$start <- as.integer(unlist(lapply(strsplit(onePerTrans$x.x,split=",",fixed=TRUE),function(a) min(as.numeric(a)))))
onePerTrans$stop <- as.integer(unlist(lapply(strsplit(onePerTrans$x.y,split=",",fixed=TRUE),function(a) max(as.numeric(a)))))

## export as BED style file for overlap  ##
write.table(onePerTrans[,c("V1","start","stop","transcript_id","V6","V7")],file="data/combined.01May14.v1.bed",sep="\t",quote=FALSE,row.names=FALSE,col.names=FALSE)
```


3.  Look for overlap between transcripts within the combined BED file  
-----------------------------------------
BEDtools version = bedtools v2.16.2-zip-5db7ff9


```
export PATH=/usr/local/bedtools2/bin:$PATH
 
cd /data/Tabastore3/LauraS/LXS/RNA-Seq/totalRNA.24Oct13/data
intersectBed -a combined.01May14.v1.bed -b combined.01May14.v1.bed -wo > overlap.refSeqGuided.txt
```

4.  Identify novel transcripts that were identified in both BN-Lx and SHR 
------------------------------------------------------
Two transcripts were "merged" into one transcripts if:  
* they are both assigned to the same strand or one/both did not have a strand designation
* they were identified as novel in opposite strains (one from SHR and one from BNLx)
* if 1) all exon starts and exon stops matched OR 2) all exon junctions matched, transcription start and stop sites could differ OR 3) two one-exon transcripts with transcription start sites within 100 bp of each other and transcription stop sites within 100 bp of each other

```{r,eval=FALSE}
overlap <- read.table(file="data/overlap.refSeqGuided.txt",sep="\t",header=FALSE)
colnames(overlap) <- c(paste(c("chr","start","stop","transcript_id","V5","strand"),rep(c("A","B"),each=6),sep="."),"overlap")

## add exon information to overlaps
setA = setB = onePerTrans[,c("transcript_id","x.x","x.y","exonNum")]
colnames(setA) = c("transcript_id.A","exonStarts.A","exonStops.A","exonNum.A")
colnames(setB) = c("transcript_id.B","exonStarts.B","exonStops.B","exonNum.B")

overlap = merge(overlap,setA,by="transcript_id.A")
overlap = merge(overlap,setB,by="transcript_id.B")

overlap$ID = c(1:nrow(overlap))

##  identify exon junction

findJunct <- function(starts,stops){
  start <- strsplit(starts,split=",",fixed=TRUE)[[1]]
  stop <- strsplit(stops,split=",",fixed=TRUE)[[1]]
  junct <- NA
  if(length(start)>1) junct <- paste(paste(stop[-length(stop)],start[-1],sep="//"),collapse=",")
  return(junct)
  }
  
overlap$exonJunct.A = apply(overlap[,c("exonStarts.A","exonStops.A")],1,function(a) findJunct(a[1],a[2]))
overlap$exonJunct.B = apply(overlap[,c("exonStarts.B","exonStops.B")],1,function(a) findJunct(a[1],a[2]))



## remove overlap that is on the opposite strand
overlap <- overlap[overlap$strand.A=="." | overlap$strand.B=="." | overlap$strand.A==overlap$strand.B,]

## remove overlap between same transcript
overlap <- overlap[overlap$transcript_id.A!=overlap$transcript_id.B,]


## remove overlap where coding regions don't overlap  ##
intronCheck =c()
for(i in 1:nrow(overlap)){
  input = overlap[i,]
  out = sum(sum(unlist(lapply(strsplit(strsplit(input[1,"exonJunct.B"],split=",")[[1]],split="//"),function(a) input[1,"start.A"]>a[1] & input[1,"stop.A"]<a[2]))),sum(unlist(lapply(strsplit(strsplit(input[1,"exonJunct.A"],split=",")[[1]],split="//"),function(a) input[1,"start.B"]>a[1] & input[1,"stop.B"]<a[2]))),na.rm=TRUE)
  intronCheck = c(intronCheck,out)
  }
  
overlap = overlap[intronCheck==0,]

##  remove overlap with annotated genes/transcripts  ##
overlap = overlap[!(grepl("NM",overlap$transcript_id.B) | grepl("NM",overlap$transcript_id.A)),]

##  remove within strain overlap ##
overlap = overlap[!(grepl("ILS",overlap$transcript_id.B) & grepl("ILS",overlap$transcript_id.A)),]
overlap = overlap[!(grepl("ISS",overlap$transcript_id.B) & grepl("ISS",overlap$transcript_id.A)),]

## transcripts without any overlap - 37,084 transcripts
noOverlap = onePerTrans[!(onePerTrans$transcript_id %in% unique(c(overlap$transcript_id.A,overlap$transcript_id.B))),]

##  perfect overlap - 190 transcripts
perfect = overlap[overlap$exonStarts.A==overlap$exonStarts.B & overlap$exonStops.A==overlap$exonStops.B,]

##  identify exon junction matches - 2,122 transcripts
reduced = overlap[!(overlap$ID %in% perfect$ID),]
exonJunctMatch <- reduced[!is.na(reduced$exonJunct.A) & !is.na(reduced$exonJunct.B) & reduced$exonJunct.A==reduced$exonJunct.B,]

##  examine one-exon transcripts - 47012 transcripts
reduced = overlap[!(overlap$ID %in% c(perfect$ID,exonJunctMatch$ID)),]
oneExons = reduced[reduced$exonNum.A==1 & reduced$exonNum.B==1,]

closeMatch.oneExon = oneExons[abs(oneExons$start.A - oneExons$start.B)<100 & abs(oneExons$stop.A - oneExons$stop.B)<100, ]
sum(duplicated(closeMatch.oneExon$transcript_id.B))

##  Check for overlap between renamed  ##
matched = as.data.frame(rbind(perfect,exonJunctMatch,closeMatch.oneExon))
sum(duplicated(matched$transcript_id.B))

##  create new transcript for matched transcripts - 8,105 matches
matched = matched[grep("ILS",matched$transcript_id.A),]

matched$transcript_id = paste("total",c(1:nrow(matched)),sep=".")
matched$gene_id = NA
matched$V1 = matched$chr.A
matched$V6 = 1000
matched$V7 = matched$strand.A
matched$start = apply(matched[,c("start.B","start.A")],1,min)
matched$stop = apply(matched[,c("stop.B","stop.A")],1,max)
matched$exonNum = matched$exonNum.A

matched$x.x = NA
matched$x.x[matched$start==matched$start.A] = matched$exonStarts.A[matched$start==matched$start.A]
matched$x.x[matched$start==matched$start.B] = matched$exonStarts.B[matched$start==matched$start.B]

matched$x.y = NA
matched$x.y[matched$stop==matched$stop.A] = matched$exonStops.A[matched$stop==matched$stop.A]
matched$x.y[matched$stop==matched$stop.B] = matched$exonStops.B[matched$stop==matched$stop.B]

matched.toAdd = matched[,colnames(onePerTrans)]

new.transcripts = onePerTrans[!(onePerTrans$transcript_id %in% c(matched$transcript_id.A,matched$transcript_id.B)),]
new.transcripts = rbind(new.transcripts,matched.toAdd)

write.table(new.transcripts[,c("V1","start","stop","transcript_id","V6","V7")],file="data/newTotal.02May14.v2.bed",sep="\t",quote=FALSE,row.names=FALSE,col.names=FALSE)
```

5.  Identify overlap between transcripts in order to identify transcripts from the same gene
------------------------------------------------------

BEDtools Version = bedtools v2.16.2-zip-5db7ff9
```
export PATH=/usr/local/bedtools2/bin:$PATH
cd /data/Tabastore3/LauraS/LXS/RNA-Seq/totalRNA.24Oct13/data
intersectBed -a newTotal.02May14.v2.bed -b newTotal.02May14.v2.bed -wo > overlap.total.forGeneID.txt
```

6.  Match transcripts to genes and create new GTF file  
------------------------------------------------------

Two transcripts are from the same gene if:  
* Their transcription start sites matched exactly OR
* Their transcription stop sites matched exactly OR
* At least one exon-exon junction matched exactly

```{r,eval=FALSE}

findJunct <- function(starts,stops){
  start <- strsplit(starts,split=",",fixed=TRUE)[[1]]
  stop <- strsplit(stops,split=",",fixed=TRUE)[[1]]
  junct <- NA
  if(length(start)>1) junct <- paste(paste(stop[-length(stop)],start[-1],sep="//"),collapse=",")
  return(junct)
  }
  
new.transcripts$exonJunct = apply(new.transcripts[,c("x.x","x.y")],1,function(a) findJunct(a[1],a[2]))

overlap = read.table(file="Data/overlap.polyA.forGeneID.txt",sep="\t",header=FALSE)
overlap = overlap[overlap$V4!=overlap$V10,]
overlap = overlap[overlap$V6=="." | overlap$V12=="." | overlap$V6==overlap$V12,]

overlap$pair = apply(overlap,1,function(a) paste(sort(a[c("V4","V10")]),collapse="//"))
overlap = overlap[!duplicated(overlap$pair),]

pairs = c()
for(i in 1:nrow(overlap)){
  x = new.transcripts[new.transcripts$transcript_id==overlap$V4[i],]
  y = new.transcripts[new.transcripts$transcript_id==overlap$V10[i],]
  sameGene = FALSE
  if(x$start==y$start | x$stop==y$stop) sameGene = TRUE
  if(!is.na(y$exonJunct) & !is.na(x$exonJunct) & sum(duplicated(c(unlist(strsplit(x$exonJunct,split=",")),unlist(strsplit(y$exonJunct,split=",")))))>0) sameGene = TRUE
  if(sameGene) pairs = rbind(pairs,c(x$transcript_id,y$transcript_id))
}


##  identify genes with multiple transcripts and create gene identifier  ##
library(igraph)
library("ggm")

edges <- pairs
graph.polyA <- graph.data.frame(edges)
graph.polyA <- igraph.to.graphNEL(graph.polyA)

compList <- connectedComp(graph.polyA)
names(compList) <- paste("polyA",c(1:length(compList)),sep=".")

multiTrans <- sapply(names(compList),function(a) cbind(gene_id.new=a,transcript_id.new=paste(a,c(1:length(compList[[a]])),sep="."),id=compList[[a]]))
multiTrans <- data.frame(do.call(rbind,multiTrans))

singleTrans <- data.frame(id=new.transcripts$transcript_id[!(new.transcripts$transcript_id %in% multiTrans$id)])
singleTrans$gene_id.new = paste("polyA",c((length(compList)+1):(length(compList)+nrow(singleTrans))),sep=".")
singleTrans$transcript_id.new = paste(singleTrans$gene_id.new,1,sep=".")

updated <- merge(new.transcripts,rbind(multiTrans,singleTrans),by.x="transcript_id",by.y="id")

##  Create New GTF File  ##

byExon = data.frame(do.call(rbind,apply(updated,1,function(tmp) data.frame(transcript_id.new = as.character(tmp[13]),V4=unlist(strsplit(as.character(tmp[6]),split=",")),V5=unlist(strsplit(as.character(tmp[7]),split=","))))))

gtf = merge(updated,byExon,by="transcript_id.new")
gtf$V2 = "CuffLinks"
gtf$V3 = "exon"
gtf$V8 = "."
gtf$V9 = paste('gene_id "',gtf$gene_id.new,'"; transcript_id "',gtf$transcript_id.new,'"; original "',gtf$transcript_id,'";',sep="")

gtf = gtf[,paste("V",c(1:9),sep="")]

write.table(gtf,file="polyA/polyA.reconstruction/transcript.polyA.24Mar14.gtf",row.names=FALSE,col.names=FALSE,quote=FALSE,sep="\t")
```

7. Use CuffLink To Check FPKM In New GTF
---------------------------------------

```
export PATH=$HOME/bin:$PATH
export PYTHONPATH=$HOME/bin:$PYTHONPATH

cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.alignedReads
cufflinks -u --seed 5464 -G /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/transcript.polyA.24Mar14.gtf -p 4 -o /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/BNLx.polyA.fpkm BNLx.polyA.bam
cufflinks -u --seed 5465 -G /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/transcript.polyA.24Mar14.gtf -p 4 -o /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/SHR.polyA.fpkm SHR.polyA.bam
```

8.  After re-quantifying with new GTF, eliminate transcripts with less than 1 FPKM in both strains and rename transcripts based on their combined (across strains) FPKM value, i.e., the transcript label '.1' is the major transcript
--------------------------------------------------

```{r,eval=FALSE}
BNLx.count = read.table(file="polyA/polyA.reconstruction/BNLx.polyA.fpkm/transcripts.gtf",sep="\t",header=FALSE)
BNLx.count = BNLx.count[BNLx.count$V3=="transcript",]
BNLx.count$transcript_id = unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript",a)])))
BNLx.count$gene_id = unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))
BNLx.count$BNLx.fpkm = as.numeric(unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))


SHR.count = read.table(file="polyA/polyA.reconstruction/SHR.polyA.fpkm/transcripts.gtf",sep="\t",header=FALSE)
SHR.count = SHR.count[SHR.count$V3=="transcript",]
SHR.count$transcript_id = unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript",a)])))
SHR.count$gene_id = unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))
SHR.count$SHR.fpkm = as.numeric(unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))

counts = merge(BNLx.count,SHR.count,by=c("gene_id","transcript_id"))
counts$sumFPKM = counts$BNLx.fpkm+counts$SHR.fpkm
counts = counts[counts$BNLx.fpkm>1 | counts$SHR.fpkm>1,c("gene_id","transcript_id","BNLx.fpkm","SHR.fpkm","sumFPKM")]
counts = counts[order(counts$gene_id,counts$sumFPKM,decreasing=TRUE),]

## rename transcripts based on FPKM  ##
newID = data.frame(do.call(rbind,aggregate(counts$transcript_id,by=list(gene_id=counts$gene_id),function(a) cbind(a,paste("polyA",strsplit(a,split=".",fixed=TRUE)[[1]][2],1:length(a),sep=".")))$x))
colnames(newID) = c("transcript_id","transcript_id.new")

##  reduce GTF file  ##
orig.gtf = read.table(file="polyA/polyA.reconstruction/transcript.polyA.24Mar14.gtf",header=FALSE,sep="\t")
orig.gtf$transcript_id = unlist(lapply(strsplit(orig.gtf$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript",a)])))
orig.gtf$gene_id = unlist(lapply(strsplit(orig.gtf$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))

new.gtf = merge(orig.gtf,newID,by="transcript_id")
new.gtf$V9 = paste('gene_id "',new.gtf$gene_id,'"; transcript_id "',new.gtf$transcript_id.new,'";',sep="")
write.table(new.gtf[,paste("V",c(1:9),sep="")],file="polyA/polyA.reconstruction/transcript.polyA.reduced.24Mar14.gtf",row.names=FALSE,col.names=FALSE,quote=FALSE,sep="\t")
```

9.  Re-quantify again based on reduced GTF
----------------------------------

```
export PATH=$HOME/bin:$PATH
export PYTHONPATH=$HOME/bin:$PYTHONPATH

cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.alignedReads

cufflinks -u --seed 5466 -G /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/transcript.polyA.reduced.24Mar14.gtf -p 4 -o /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/BNLx.polyA.reduced.fpkm BNLx.polyA.bam

cufflinks -u --seed 5467 -G /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/transcript.polyA.reduced.24Mar14.gtf -p 4 -o /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/SHR.polyA.reduced.fpkm SHR.polyA.bam

```


10.  After re-quantifying with new GTF, eliminate transcripts with less than 1 FPKM in both strains and rename transcripts based on their combined (across strains) FPKM value, i.e., the transcript label '.1' is the major transcript
--------------------------------------------------

```{r,eval=FALSE}
rm(list=ls())
options(stringsAsFactors=FALSE)

BNLx.count = read.table(file="polyA/polyA.reconstruction/BNLx.polyA.reduced.fpkm/transcripts.gtf",sep="\t",header=FALSE)
BNLx.count = BNLx.count[BNLx.count$V3=="transcript",]
BNLx.count$transcript_id = unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript",a)])))
BNLx.count$gene_id = unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))
BNLx.count$BNLx.fpkm = as.numeric(unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))


SHR.count = read.table(file="polyA/polyA.reconstruction/SHR.polyA.reduced.fpkm/transcripts.gtf",sep="\t",header=FALSE)
SHR.count = SHR.count[SHR.count$V3=="transcript",]
SHR.count$transcript_id = unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript",a)])))
SHR.count$gene_id = unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))
SHR.count$SHR.fpkm = as.numeric(unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))

counts = merge(BNLx.count,SHR.count,by=c("gene_id","transcript_id"))
counts$sumFPKM = counts$BNLx.fpkm+counts$SHR.fpkm
counts = counts[counts$BNLx.fpkm>1 | counts$SHR.fpkm>1,c("gene_id","transcript_id","BNLx.fpkm","SHR.fpkm","sumFPKM")]
counts = counts[order(counts$gene_id,counts$sumFPKM,decreasing=TRUE),]

## rename transcripts based on FPKM  ##
newID = data.frame(do.call(rbind,aggregate(counts$transcript_id,by=list(gene_id=counts$gene_id),function(a) cbind(a,paste("polyA",strsplit(a,split=".",fixed=TRUE)[[1]][2],1:length(a),sep=".")))$x))
colnames(newID) = c("transcript_id","transcript_id.new")

##  reduce GTF file  ##
orig.gtf = read.table(file="polyA/polyA.reconstruction/transcript.polyA.reduced.24Mar14.gtf",header=FALSE,sep="\t")
orig.gtf$transcript_id = unlist(lapply(strsplit(orig.gtf$V9,split=";"),function(a) gsub(" transcript_id ","",a[grep("transcript",a)])))
orig.gtf$gene_id = unlist(lapply(strsplit(orig.gtf$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))

new.gtf = merge(orig.gtf,newID,by="transcript_id")
new.gtf$V9 = paste('gene_id "',new.gtf$gene_id,'"; transcript_id "',new.gtf$transcript_id.new,'";',sep="")
write.table(new.gtf[,paste("V",c(1:9),sep="")],file="polyA/polyA.reconstruction/transcript.polyA.reduced.v2.25Mar14.gtf",row.names=FALSE,col.names=FALSE,quote=FALSE,sep="\t")
```



11.  Re-quantify again based on reduced GTF
----------------------------------

```
export PATH=$HOME/bin:$PATH
export PYTHONPATH=$HOME/bin:$PYTHONPATH

cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.alignedReads

cufflinks -u --seed 5468 -G /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/transcript.polyA.reduced.v2.25Mar14.gtf -p 4 -o /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/BNLx.polyA.reduced.v2.fpkm BNLx.polyA.bam

cufflinks -u --seed 5469 -G /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/transcript.polyA.reduced.v2.25Mar14.gtf -p 4 -o /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/SHR.polyA.reduced.v2.fpkm SHR.polyA.bam

```

12. After re-quantifying with new GTF, eliminate transcripts with less than 1 FPKM in both strains and rename transcripts based on their combined (across strains) FPKM value, i.e., the transcript label '.1' is the major transcript
--------------------------------------------------

```{r,eval=FALSE}
BNLx.count = read.table(file="polyA/polyA.reconstruction/BNLx.polyA.reduced.v2.fpkm/transcripts.gtf",sep="\t",header=FALSE)
BNLx.count = BNLx.count[BNLx.count$V3=="transcript",]
BNLx.count$transcript_id = unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript",a)])))
BNLx.count$gene_id = unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))
BNLx.count$BNLx.fpkm = as.numeric(unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))


SHR.count = read.table(file="polyA/polyA.reconstruction/SHR.polyA.reduced.v2.fpkm/transcripts.gtf",sep="\t",header=FALSE)
SHR.count = SHR.count[SHR.count$V3=="transcript",]
SHR.count$transcript_id = unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript",a)])))
SHR.count$gene_id = unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))
SHR.count$SHR.fpkm = as.numeric(unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))

counts = merge(BNLx.count,SHR.count,by=c("gene_id","transcript_id"))
counts$sumFPKM = counts$BNLx.fpkm+counts$SHR.fpkm

sum(counts$BNLx.fpkm<1 & counts$SHR.fpkm<1)
sum(counts$sumFPKM<1)
counts[counts$BNLx.fpkm<1 & counts$SHR.fpkm<1,]

counts = counts[counts$BNLx.fpkm>1 | counts$SHR.fpkm>1,c("gene_id","transcript_id","BNLx.fpkm","SHR.fpkm","sumFPKM")]
counts = counts[order(counts$gene_id,counts$sumFPKM,decreasing=TRUE),]

## rename transcripts based on FPKM  ##
newID = data.frame(do.call(rbind,aggregate(counts$transcript_id,by=list(gene_id=counts$gene_id),function(a) cbind(a,paste("polyA",strsplit(a,split=".",fixed=TRUE)[[1]][2],1:length(a),sep=".")))$x))
colnames(newID) = c("transcript_id","transcript_id.new")

##  reduce GTF file  ##
orig.gtf = read.table(file="polyA/polyA.reconstruction/transcript.polyA.reduced.v2.25Mar14.gtf",header=FALSE,sep="\t")
orig.gtf$transcript_id = unlist(lapply(strsplit(orig.gtf$V9,split=";"),function(a) gsub(" transcript_id ","",a[grep("transcript",a)])))
orig.gtf$gene_id = unlist(lapply(strsplit(orig.gtf$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))

new.gtf = merge(orig.gtf,newID,by="transcript_id")
new.gtf$V9 = paste('gene_id "',new.gtf$gene_id,'"; transcript_id "',new.gtf$transcript_id.new,'";',sep="")
write.table(new.gtf[,paste("V",c(1:9),sep="")],file="polyA/polyA.reconstruction/transcript.polyA.reduced.v3.25Mar14.gtf",row.names=FALSE,col.names=FALSE,quote=FALSE,sep="\t")
```

13.  Re-quantify again based on reduced GTF
----------------------------------

```
export PATH=$HOME/bin:$PATH
export PYTHONPATH=$HOME/bin:$PYTHONPATH

cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.alignedReads

cufflinks -u --seed 5468 -G /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/transcript.polyA.reduced.v3.25Mar14.gtf -p 4 -o /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/BNLx.polyA.reduced.v3.fpkm BNLx.polyA.bam

cufflinks -u --seed 5469 -G /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/transcript.polyA.reduced.v3.25Mar14.gtf -p 4 -o /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/SHR.polyA.reduced.v3.fpkm SHR.polyA.bam

```

14. After re-quantifying with new GTF, eliminate transcripts with less than 1 FPKM in both strains and rename transcripts based on their combined (across strains) FPKM value, i.e., the transcript label '.1' is the major transcript
--------------------------------------------------

```{r,eval=FALSE}
BNLx.count = read.table(file="polyA/polyA.reconstruction/BNLx.polyA.reduced.v3.fpkm/transcripts.gtf",sep="\t",header=FALSE)
BNLx.count = BNLx.count[BNLx.count$V3=="transcript",]
BNLx.count$transcript_id = unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript",a)])))
BNLx.count$gene_id = unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))
BNLx.count$BNLx.fpkm = as.numeric(unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))


SHR.count = read.table(file="polyA/polyA.reconstruction/SHR.polyA.reduced.v3.fpkm/transcripts.gtf",sep="\t",header=FALSE)
SHR.count = SHR.count[SHR.count$V3=="transcript",]
SHR.count$transcript_id = unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript",a)])))
SHR.count$gene_id = unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))
SHR.count$SHR.fpkm = as.numeric(unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))

counts = merge(BNLx.count,SHR.count,by=c("gene_id","transcript_id"))
counts$sumFPKM = counts$BNLx.fpkm+counts$SHR.fpkm

sum(counts$BNLx.fpkm<1 & counts$SHR.fpkm<1)
sum(counts$sumFPKM<1)
```

ALL TRANSCRIPTS WITH FPKM>1 IN AT LEAST ONE STRAIN

cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/
mv transcript.polyA.reduced.v3.25Mar14.gtf transcript.polyA.clean.26Mar14.gtf
mv BNLx.polyA.reduced.v3.fpkm BNLx.polyA.cleaned.fpkm
mv SHR.polyA.reduced.v3.fpkm SHR.polyA.cleaned.fpkm

rm transcript.polyA.reduced.*
rm BNLx.polyA.reduced.*/*
rm SHR.polyA.reduced.*/*
rmdir BNLx.polyA.reduced.*
rmdir SHR.polyA.reduced.*



```{r}
rm(list=ls())
options(stringsAsFactors=FALSE)
setwd("/Volumes/LauraS/LXS/RNA-Seq/totalRNA.24Oct13")

ILS <- read.table(file="reconstruction/ILS.total.ensemblGuided/transcripts.gtf",sep="\t",header=FALSE)
ILS$transcript_id = unlist(lapply(strsplit(ILS$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript_id",a)])))
ILS$gene_id = unlist(lapply(strsplit(ILS$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene_id",a)])))
ILS$fpkm = as.numeric(unlist(lapply(strsplit(ILS$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))

ILS = ILS[ILS$fpkm!=0,]
ILS = ILS[!grepl("ERCC",ILS$V1),]
ILS$V1 = paste("chr",ILS$V1,sep="")

tmp = ILS[,c("V1","transcript_id")]
tmp = tmp[!duplicated(tmp),]
tmp = tmp[duplicated(tmp$transcript_id),]

for(i in 1:nrow(tmp)){
  ILS$V9[ILS$transcript_id==tmp[i,"transcript_id"] & ILS$V1==tmp[i,"V1"]] = gsub(tmp[i,"transcript_id"],paste(tmp[i,],collapse="_"), ILS$V9[ILS$transcript_id==tmp[i,"transcript_id"] & ILS$V1==tmp[i,"V1"]])
  }

write.table(ILS[,paste("V",1:9,sep="")],file="reconstruction/ILS.total.ensemblGuided/transcripts.forUCSC.gtf",sep="\t",quote=FALSE,row.names=FALSE,col.names=FALSE)

ISS <- read.table(file="reconstruction/ISS.total.ensemblGuided/transcripts.gtf",sep="\t",header=FALSE)
ISS$transcript_id = unlist(lapply(strsplit(ISS$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript_id",a)])))
ISS$gene_id = unlist(lapply(strsplit(ISS$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene_id",a)])))
ISS$fpkm = as.numeric(unlist(lapply(strsplit(ISS$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))

ISS = ISS[ISS$fpkm!=0,]
ISS = ISS[!grepl("ERCC",ISS$V1),]
ISS$V1 = paste("chr",ISS$V1,sep="")

tmp = ISS[,c("V1","transcript_id")]
tmp = tmp[!duplicated(tmp),]
tmp = tmp[duplicated(tmp$transcript_id),]

for(i in 1:nrow(tmp)){
  ISS$V9[ISS$transcript_id==tmp[i,"transcript_id"] & ISS$V1==tmp[i,"V1"]] = gsub(tmp[i,"transcript_id"],paste(tmp[i,],collapse="_"), ISS$V9[ISS$transcript_id==tmp[i,"transcript_id"] & ISS$V1==tmp[i,"V1"]])
  }

write.table(ISS[,paste("V",1:9,sep="")],file="reconstruction/ISS.total.ensemblGuided/transcripts.forUCSC.gtf",sep="\t",quote=FALSE,row.names=FALSE,col.names=FALSE)

ILS[ILS$transcript_id %in% c("NM_001081979","NM_010788"),]
ISS[ISS$transcript_id %in% c("NM_001081979","NM_010788"),]


```