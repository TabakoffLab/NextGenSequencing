Compare Transcriptome-Guided Reconstructions of Liver Total RNA Between BNLx and SHR
========================================================

1.  Import GTF files and limit transcripts to those that have FPKM>1 in at least on strain and are larger than 300 bp (not including introns)
--------------------------

```{r, eval=FALSE}
rm(list=ls())
options(stringsAsFactors=FALSE)
setwd("/Volumes/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD")

BNLx <- read.table(file="reconstruction/BNLx.total.refSeqGuided/transcripts.gtf",sep="\t",header=FALSE)
BNLx$transcript_id = unlist(lapply(strsplit(BNLx$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript_id",a)])))
BNLx$gene_id = unlist(lapply(strsplit(BNLx$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene_id",a)])))
BNLx$fpkm = as.numeric(unlist(lapply(strsplit(BNLx$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))

BNLx.exons = BNLx[BNLx$V3=="exon",]
BNLx.exons$length = BNLx.exons$V5 - BNLx.exons$V4 + 1

tmp = cbind(aggregate(BNLx.exons$length,by=list(BNLx.exons$transcript_id),sum),aggregate(BNLx.exons$transcript_id,by=list(BNLx.exons$transcript_id),length)$x)
colnames(tmp) = c("transcript_id","length","numExons")

BNLx.transcripts = BNLx[BNLx$V3=="transcript",]
BNLx.transcripts = merge(BNLx.transcripts, tmp,by="transcript_id")
BNLx.transcripts = BNLx.transcripts[BNLx.transcripts$fpkm!=0 & BNLx.transcripts$length>300,]

## SHR ##
#DBA <- read.table(file="reconstruction/DBA.ensemblGuided/transcripts.gtf",sep="\t",header=FALSE)
#DBA$transcript_id = unlist(lapply(strsplit(DBA$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript_id",a)])))
#DBA$gene_id = unlist(lapply(strsplit(DBA$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene_id",a)])))
#DBA$fpkm = as.numeric(unlist(lapply(strsplit(DBA$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))

#DBA.exons = DBA[DBA$V3=="exon",]
#DBA.exons$length = DBA.exons$V5 - DBA.exons$V4 + 1

#tmp = cbind(aggregate(DBA.exons$length,by=list(DBA.exons$transcript_id),sum),aggregate(DBA.exons$transcript_id,by=list(DBA.exons$transcript_id),length)$x)
#colnames(tmp) = c("transcript_id","length","numExons")

#DBA.transcripts = DBA[DBA$V3=="transcript",]
#DBA.transcripts = merge(DBA.transcripts, tmp,by="transcript_id")
#DBA.transcripts = DBA.transcripts[DBA.transcripts$fpkm!=0 & DBA.transcripts$length>300,]

SHR=c()
SHR.transcripts=c()
save(BNLx.transcripts,SHR.transcripts,BNLx,SHR,file="Rdata/origRecon.Rdata")
```

```{r,echo=FALSE}
rm(list=ls())
options(stringsAsFactors=FALSE)
setwd("/Volumes/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD")
load("Rdata/origRecon.Rdata")
```

Comparison of Transcriptomes
----------------------------

* Number of Genes  
DBA = `r length(unique(DBA.transcripts$gene_id))`  
ISS = `r length(unique(ISS.transcripts$gene_id))`  

* Number of Transcripts  
ILS = `r nrow(ILS.transcripts)`  
ISS = `r nrow(ISS.transcripts)`  

* Average Number of Transcripts Per Gene  
ILS = `r nrow(ILS.transcripts)/length(unique(ILS.transcripts$gene_id))`  
ISS = `r nrow(ISS.transcripts)/length(unique(ISS.transcripts$gene_id))`  

* Max Number of Transcripts Per Gene  
ILS = `r max(table(ILS.transcripts$gene_id))`  
ISS = `r max(table(ISS.transcripts$gene_id))`  

* Number of RefSeq Genes Recovered    
ILS = `r sum(grepl("N",ILS.transcripts$transcript_id))`  
ISS = `r sum(grepl("N",ISS.transcripts$transcript_id))`  


2. Concatenate novel transcripts between strains, merge expressed RefSeq transcripts, and created BED File
--------------------------------------------------------------------------
```{r,eval=FALSE}

#DBA.transcripts = DBA.transcripts[,c("transcript_id","gene_id","fpkm","length","numExons","V1","V4","V5")]
#colnames(DBA.transcripts) = paste("DBA.",colnames(DBA.transcripts),sep="")

BNLx.transcripts = BNLx.transcripts[,c("transcript_id","gene_id","fpkm","length","numExons","V1","V4","V5")]
colnames(BNLx.transcripts) = paste("BNLx.",colnames(BNLx.transcripts),sep="")

#DBA.transcripts$transcript_id = gsub("CUFF","DBA",DBA.transcripts$DBA.transcript_id)
BNLx.transcripts$transcript_id = gsub("CUFF","BNLx",BNLx.transcripts$BNLx.transcript_id)

#transcripts = merge(BNLx.transcripts[BNLx.transcripts$BNLx.fpkm>1,],SHR.transcripts[SHR.transcripts$SHR.fpkm>1,],by="transcript_id",all=TRUE)
transcripts =BNLx.transcripts[BNLx.transcripts$BNLx.fpkm>0.1,]

##  Convert to BED File  ##

BNLx.v2 = BNLx
BNLx.v2$transcript_id = gsub("CUFF","BNLx",BNLx.v2$transcript_id)
BNLx.v2$gene_id = gsub("CUFF","BNLx",BNLx.v2$gene_id)

#DBA.v2 = DBA
#DBA.v2$transcript_id = gsub("CUFF","DBA",DBA.v2$transcript_id)
#DBA.v2$gene_id = gsub("CUFF","DBA",DBA.v2$gene_id)

#combinedGTF = rbind(C57.v2,DBA.v2)
combinedGTF = BNLx.v2
combinedGTF = combinedGTF[,!(colnames(combinedGTF) %in% c("V9","fpkm"))]
combinedGTF = combinedGTF[!duplicated(combinedGTF),]
combinedGTF = combinedGTF[combinedGTF$transcript_id %in% transcripts$transcript_id,]

gtf <- combinedGTF[combinedGTF$V3=="exon",]
gtf <- gtf[order(gtf$transcript_id,gtf$V4,gtf$V5),]

print(paste("Number of Genes ",length(unique(gtf$gene_id)),sep=""))
print(paste("Number of Transcripts ",length(unique(gtf$transcript_id)),sep=""))

##  create one per transcript ##
start <- aggregate(gtf$V4,by=list(gtf$transcript_id),function(a) paste(a,collapse=","))
stop <- aggregate(gtf$V5,by=list(gtf$transcript_id),function(a) paste(a,collapse=","))
transcripts <- gtf[!duplicated(gtf[,c("transcript_id","V1")]),c("transcript_id","gene_id","V1","V6","V7")]
onePerTrans <- merge(start,stop,by=1)
onePerTrans <- merge(transcripts,onePerTrans,by=1)

onePerTrans$exonNum = unlist(lapply(strsplit(onePerTrans$x.x,split=",",fixed=TRUE),length))
onePerTrans$start <- as.integer(unlist(lapply(strsplit(onePerTrans$x.x,split=",",fixed=TRUE),function(a) min(as.numeric(a)))))
onePerTrans$stop <- as.integer(unlist(lapply(strsplit(onePerTrans$x.y,split=",",fixed=TRUE),function(a) max(as.numeric(a)))))

## export as BED style file for overlap  ##
write.table(onePerTrans[,c("V1","start","stop","transcript_id","V6","V7")],file="data/BNLx.Liver.07May14.v1.bed",sep="\t",quote=FALSE,row.names=FALSE,col.names=FALSE)
```


3.  Look for overlap between transcripts within the combined BED file  
-----------------------------------------
BEDtools version = bedtools v2.16.2-zip-5db7ff9


```
export PATH=/usr/local/bedtools2/bin:$PATH
 
#cd /data/Tabastore3/LauraS/BXD/RNA-Seq/Sanger/data
cd /Volumes/LauraS/BXD/RNA-Seq/Sanger/data
intersectBed -a combined.07May14.v1.bed -b combined.07May14.v1.bed -wo > overlap.refSeqGuided.07May14.txt
```

4.  Identify novel transcripts that were identified in both BN-Lx and SHR 
------------------------------------------------------
Two transcripts were "merged" into one transcripts if:  
* they are both assigned to the same strand or one/both did not have a strand designation
* they were identified as novel in opposite strains (one from SHR and one from BNLx)
* if 1) all exon starts and exon stops matched OR 2) all exon junctions matched, transcription start and stop sites could differ OR 3) two one-exon transcripts with transcription start sites within 100 bp of each other and transcription stop sites within 100 bp of each other

```{r,eval=FALSE}
overlap <- read.table(file="data/overlap.ensGuided.txt",sep="\t",header=FALSE)
colnames(overlap) <- c(paste(c("chr","start","stop","transcript_id","V5","strand"),rep(c("A","B"),each=6),sep="."),"overlap")

## add exon information to overlaps
setA = setB = onePerTrans[,c("transcript_id","x.x","x.y","exonNum")]
colnames(setA) = c("transcript_id.A","exonStarts.A","exonStops.A","exonNum.A")
colnames(setB) = c("transcript_id.B","exonStarts.B","exonStops.B","exonNum.B")

overlap = merge(overlap,setA,by="transcript_id.A")
overlap = merge(overlap,setB,by="transcript_id.B")

overlap$ID = c(1:nrow(overlap))

##  identify exon junction

findJunct <- function(starts,stops){
  start <- strsplit(starts,split=",",fixed=TRUE)[[1]]
  stop <- strsplit(stops,split=",",fixed=TRUE)[[1]]
  junct <- NA
  if(length(start)>1) junct <- paste(paste(stop[-length(stop)],start[-1],sep="//"),collapse=",")
  return(junct)
  }
  
overlap$exonJunct.A = apply(overlap[,c("exonStarts.A","exonStops.A")],1,function(a) findJunct(a[1],a[2]))
overlap$exonJunct.B = apply(overlap[,c("exonStarts.B","exonStops.B")],1,function(a) findJunct(a[1],a[2]))



## remove overlap that is on the opposite strand
overlap <- overlap[overlap$strand.A=="." | overlap$strand.B=="." | overlap$strand.A==overlap$strand.B,]

## remove overlap between same transcript
overlap <- overlap[overlap$transcript_id.A!=overlap$transcript_id.B,]


## remove overlap where coding regions don't overlap  ##
intronCheck =c()
for(i in 1:nrow(overlap)){
  input = overlap[i,]
  out = sum(sum(unlist(lapply(strsplit(strsplit(input[1,"exonJunct.B"],split=",")[[1]],split="//"),function(a) input[1,"start.A"]>a[1] & input[1,"stop.A"]<a[2]))),sum(unlist(lapply(strsplit(strsplit(input[1,"exonJunct.A"],split=",")[[1]],split="//"),function(a) input[1,"start.B"]>a[1] & input[1,"stop.B"]<a[2]))),na.rm=TRUE)
  intronCheck = c(intronCheck,out)
  }
  
overlap = overlap[intronCheck==0,]

##  remove overlap with annotated genes/transcripts  ##
overlap = overlap[!(grepl("ENS",overlap$transcript_id.B) | grepl("ENS",overlap$transcript_id.A)),]

##  remove within strain overlap ##
overlap = overlap[!(grepl("C57",overlap$transcript_id.B) & grepl("C57",overlap$transcript_id.A)),]
overlap = overlap[!(grepl("DBA",overlap$transcript_id.B) & grepl("DBA",overlap$transcript_id.A)),]

## transcripts without any overlap - 47,361 transcripts
noOverlap = onePerTrans[!(onePerTrans$transcript_id %in% unique(c(overlap$transcript_id.A,overlap$transcript_id.B))),]

##  perfect overlap - 32 transcripts
perfect = overlap[overlap$exonStarts.A==overlap$exonStarts.B & overlap$exonStops.A==overlap$exonStops.B,]

##  identify exon junction matches - 1,740 transcripts
reduced = overlap[!(overlap$ID %in% perfect$ID),]
exonJunctMatch <- reduced[!is.na(reduced$exonJunct.A) & !is.na(reduced$exonJunct.B) & reduced$exonJunct.A==reduced$exonJunct.B,]

##  examine one-exon transcripts - 8026 transcripts
reduced = overlap[!(overlap$ID %in% c(perfect$ID,exonJunctMatch$ID)),]
oneExons = reduced[reduced$exonNum.A==1 & reduced$exonNum.B==1,]

closeMatch.oneExon = oneExons[abs(oneExons$start.A - oneExons$start.B)<100 & abs(oneExons$stop.A - oneExons$stop.B)<100, ]
sum(duplicated(closeMatch.oneExon$transcript_id.B))
sum(duplicated(closeMatch.oneExon$transcript_id.A))

##  Check for overlap between renamed  ##
matched = as.data.frame(rbind(perfect,exonJunctMatch,closeMatch.oneExon))
sum(duplicated(matched$transcript_id.B))

##  create new transcript for matched transcripts - 8,105 matches
matched = matched[grep("C57",matched$transcript_id.A),]

matched$transcript_id = paste("total",c(1:nrow(matched)),sep=".")
matched$gene_id = NA
matched$V1 = matched$chr.A
matched$V6 = 1000
matched$V7 = matched$strand.A
matched$start = apply(matched[,c("start.B","start.A")],1,min)
matched$stop = apply(matched[,c("stop.B","stop.A")],1,max)
matched$exonNum = matched$exonNum.A

matched$x.x = NA
matched$x.x[matched$start==matched$start.A] = matched$exonStarts.A[matched$start==matched$start.A]
matched$x.x[matched$start==matched$start.B] = matched$exonStarts.B[matched$start==matched$start.B]

matched$x.y = NA
matched$x.y[matched$stop==matched$stop.A] = matched$exonStops.A[matched$stop==matched$stop.A]
matched$x.y[matched$stop==matched$stop.B] = matched$exonStops.B[matched$stop==matched$stop.B]

matched.toAdd = matched[,colnames(onePerTrans)]

new.transcripts = onePerTrans[!(onePerTrans$transcript_id %in% c(matched$transcript_id.A,matched$transcript_id.B)),]
new.transcripts = rbind(new.transcripts,matched.toAdd)

write.table(new.transcripts[,c("V1","start","stop","transcript_id","V6","V7")],file="data/newTotal.05May14.v2.bed",sep="\t",quote=FALSE,row.names=FALSE,col.names=FALSE)
```

5.  Identify overlap between transcripts in order to identify transcripts from the same gene
------------------------------------------------------

BEDtools Version = bedtools v2.16.2-zip-5db7ff9
```
cd /Volumes/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD/data
intersectBed -a BNLx.Liver.07May14.v1.bed -b BNLx.Liver.07May14.v1.bed -wo > overlap.total.forGeneID.07May14.txt
```

6.  Match transcripts to genes and create new GTF file  
------------------------------------------------------

Two transcripts are from the same gene if:  
* Their transcription start sites matched exactly OR
* Their transcription stop sites matched exactly OR
* At least one exon-exon junction matched exactly

```{r,eval=FALSE}

findJunct <- function(starts,stops){
  start <- strsplit(starts,split=",",fixed=TRUE)[[1]]
  stop <- strsplit(stops,split=",",fixed=TRUE)[[1]]
  junct <- NA
  if(length(start)>1) junct <- paste(paste(stop[-length(stop)],start[-1],sep="//"),collapse=",")
  return(junct)
  }
  
new.transcripts = onePerTrans #delete when merging
new.transcripts$exonJunct = apply(new.transcripts[,c("x.x","x.y")],1,function(a) findJunct(a[1],a[2]))

overlap = read.table(file="data/overlap.total.forGeneID.07May14.txt",sep="\t",header=FALSE)
overlap = overlap[overlap$V4!=overlap$V10,]
overlap = overlap[overlap$V6=="." | overlap$V12=="." | overlap$V6==overlap$V12,]

overlap$pair = apply(overlap,1,function(a) paste(sort(a[c("V4","V10")]),collapse="//"))
overlap = overlap[!duplicated(overlap$pair),]

pairs = c()
for(i in 1:nrow(overlap)){
  x = new.transcripts[new.transcripts$transcript_id==overlap$V4[i],]
  y = new.transcripts[new.transcripts$transcript_id==overlap$V10[i],]
  sameGene = FALSE
  if(x$start==y$start | x$stop==y$stop) sameGene = TRUE
  if(!is.na(y$exonJunct) & !is.na(x$exonJunct) & sum(duplicated(c(unlist(strsplit(x$exonJunct,split=",")),unlist(strsplit(y$exonJunct,split=",")))))>0) sameGene = TRUE
  if(sameGene) pairs = rbind(pairs,c(x$transcript_id,y$transcript_id))
}


##  identify genes with multiple transcripts and create gene identifier  ##
library("igraph")
library("ggm")
library("RBGL")

edges <- pairs
graph.polyA <- graph.data.frame(edges)
graph.polyA <- igraph.to.graphNEL(graph.polyA)

compList <- connectedComp(graph.polyA)
names(compList) <- paste("total",c(1:length(compList)),sep=".")

multiTrans <- sapply(names(compList),function(a) cbind(gene_id.new=a,transcript_id.new=paste(a,c(1:length(compList[[a]])),sep="."),id=compList[[a]]))
multiTrans <- data.frame(do.call(rbind,multiTrans))

singleTrans <- data.frame(id=new.transcripts$transcript_id[!(new.transcripts$transcript_id %in% multiTrans$id)])
singleTrans$gene_id.new = paste("total",c((length(compList)+1):(length(compList)+nrow(singleTrans))),sep=".")
singleTrans$transcript_id.new = paste(singleTrans$gene_id.new,1,sep=".")

updated <- merge(new.transcripts,rbind(multiTrans,singleTrans),by.x="transcript_id",by.y="id")

##  Create New GTF File  ##

byExon = data.frame(do.call(rbind,apply(updated,1,function(tmp) data.frame(transcript_id.new = as.character(tmp[13]),V4=unlist(strsplit(as.character(tmp[6]),split=",")),V5=unlist(strsplit(as.character(tmp[7]),split=","))))))

gtf = merge(updated,byExon,by="transcript_id.new")
gtf$V2 = "CuffLinks"
gtf$V3 = "exon"
gtf$V8 = "."
gtf$V9 = paste('gene_id "',gtf$gene_id.new,'"; transcript_id "',gtf$transcript_id.new,'"; original "',gtf$transcript_id,'";',sep="")

gtf = gtf[,paste("V",c(1:9),sep="")]

write.table(gtf,file="reconstruction/BNLx.Liver.07May14.gtf",row.names=FALSE,col.names=FALSE,quote=FALSE,sep="\t")
```

### Create GTF Files to Upload to UCSC
```{r}
rm(list=ls())
options(stringsAsFactors=FALSE)
setwd("/Volumes/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD")

gtf = read.table(file="reconstruction/BNLx.Liver.05May14.gtf",header=FALSE,sep="\t")
gtf = gtf[!grepl("ERCC",gtf$V1),]
write.table(gtf,file="reconstruction/BNLx.Liver.05May14.forUCSC.gtf",row.names=FALSE,col.names=FALSE,quote=FALSE,sep="\t")

orig <- read.table(file="reconstruction/BNLx.total.refSeqGuided/transcripts.gtf",sep="\t",header=FALSE)
orig = orig[!grepl("ERCC",orig$V1),]
write.table(orig,file="reconstruction/BNLx.total.refSeqGuided/transcripts.forUCSC.gtf",row.names=FALSE,col.names=FALSE,quote=FALSE,sep="\t")

```


7. Use SailFish To Check Quantification In New GTF
---------------------------------------

### Extract sequence of transcripts
```
# create genome with spikes
cd /data/Tabastore3/LauraS/index
cat /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/index/rn5_No_Random.fa /data/Tabastore3/LauraS/BxH.HxB.Rats/RNA-Seq/spikeSource/ERCC92.fa > rn5_wSpikes.fa

# index genome
cd /Volumes/LauraS/index
samtools faidx rn5_wSpikes.fa

# generate fasta file of transcript sequences
cd /Volumes/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD/reconstruction
gffread -w BNLx.Liver.05May14.fa -g /Volumes/LauraS/index/rn5_wSpikes.fa BNLx.Liver.05May14.gtf
gffread -w BNLx.Liver.07May14.fa -g /Volumes/LauraS/index/rn5_wSpikes.fa BNLx.Liver.07May14.gtf
```

### Quantify Using SailFish
```
qsub -q smp-q /home/saba/BNLx.SHR.Liver.totalRNA.UCD/programs/sailFish.quant.v1.sh
```

```
export LD_LIBRARY_PATH=/usr/local/sailfish/lib:$LD_LIBRARY_PATH
export PATH=/usr/local/sailfish/bin:$PATH
cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD/reconstruction
sailfish index -t BNLx.Liver.07May14.fa -k 20 -p 5 -o BNLx.liver.transcriptome.07May14.v1

cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD
sailfish quant -i ./reconstruction/BNLx.liver.transcriptome.07May14.v1 -l "T=PE:O=><:S=AS" -1 ./trimmedReads/BNLX_1_GCCAAT_L005_R1_001_val_1.fq -2 ./trimmedReads/BNLX_1_GCCAAT_L005_R2_001_val_2.fq -p 4 -o ./quantification/sailFish.v1/BNLx1

sailfish quant -i ./reconstruction/BNLx.liver.transcriptome.07May14.v1 -l "T=PE:O=><:S=AS" -1 ./trimmedReads/BNLX_2_CAGATC_L006_R1_001_val_1.fq -2 ./trimmedReads/BNLX_2_CAGATC_L006_R2_001_val_2.fq -p 4 -o ./quantification/sailFish.v1/BNLx2

sailfish quant -i ./reconstruction/BNLx.liver.transcriptome.07May14.v1 -l "T=PE:O=><:S=AS" -1 ./trimmedReads/BNLX_3_CTTGTA_L007_R1_001_val_1.fq -2 ./trimmedReads/BNLX_3_CTTGTA_L007_R2_001_val_2.fq -p 4 -o ./quantification/sailFish.v1/BNLx3

```

```{r}
rm(list=ls())
options(stringsAsFactors=FALSE)
setwd("/Volumes/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD/")
BNLx1.count = read.table(file="quantification/sailFish.v1/BNLx1/quant_bias_corrected.sf",sep="\t",header=FALSE)
BNLx2.count = read.table(file="quantification/sailFish.v1/BNLx2/quant_bias_corrected.sf",sep="\t",header=FALSE)
BNLx3.count = read.table(file="quantification/sailFish.v1/BNLx3/quant_bias_corrected.sf",sep="\t",header=FALSE)

colnames(BNLx1.count) = c("transcript_id","length",paste("BNLx1",c("TPM","RPKM","KPKM","EstNumKmers","EstNumReads"),sep="."))
colnames(BNLx2.count) = c("transcript_id","length",paste("BNLx2",c("TPM","RPKM","KPKM","EstNumKmers","EstNumReads"),sep="."))
colnames(BNLx3.count) = c("transcript_id","length",paste("BNLx3",c("TPM","RPKM","KPKM","EstNumKmers","EstNumReads"),sep="."))

counts = merge(BNLx1.count,BNLx2.count,by=c("transcript_id","length"))
counts = merge(counts,BNLx3.count,by=c("transcript_id","length"))

counts$numSamplesGrt1 = rowSums(counts[,grep("TPM",colnames(counts))]>1)
counts = counts[counts$numSamplesGrt1!=0,]

counts$gene_id = paste("total",unlist(lapply(strsplit(counts$transcript_id,split=".",fixed=TRUE),function(a) a[2])),sep=".")

counts$sumTPM = rowSums(counts[,grep("TPM",colnames(counts))])
counts = counts[order(counts$gene_id,counts$sumTPM,decreasing=TRUE),]

## rename transcripts based on FPKM  ##
newID = data.frame(do.call(rbind,aggregate(counts$transcript_id,by=list(gene_id=counts$gene_id),function(a) cbind(a,paste("polyA",strsplit(a,split=".",fixed=TRUE)[[1]][2],1:length(a),sep=".")))$x))
colnames(newID) = c("transcript_id","transcript_id.new")

##  reduce GTF file  ##
orig.gtf = read.table(file="reconstruction/BNLx.Liver.07May14.gtf",header=FALSE,sep="\t")
orig.gtf$transcript_id = unlist(lapply(strsplit(orig.gtf$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript",a)])))
orig.gtf$gene_id = unlist(lapply(strsplit(orig.gtf$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))

new.gtf = merge(orig.gtf,newID,by="transcript_id")
new.gtf$V9 = paste('gene_id "',new.gtf$gene_id,'"; transcript_id "',new.gtf$transcript_id.new,'";',sep="")
write.table(new.gtf[,paste("V",c(1:9),sep="")],file="reconstruction/BNLx.Liver.08May14.v2.gtf",row.names=FALSE,col.names=FALSE,quote=FALSE,sep="\t")
```

##  Requantify - VERSION 2

# generate fasta file of transcript sequences
cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD/reconstruction
gffread -w BNLx.Liver.08May14.v2.fa -g /data/Tabastore3/LauraS/index/rn5_wSpikes.fa BNLx.Liver.08May14.v2.gtf
```

### Quantify Using SailFish

```
export LD_LIBRARY_PATH=/usr/local/sailfish/lib:$LD_LIBRARY_PATH
export PATH=/usr/local/sailfish/bin:$PATH
cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD/reconstruction
sailfish index -t BNLx.Liver.08May14.v2.fa -k 20 -p 5 -o BNLx.liver.transcriptome.08May14.v2

cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD
sailfish quant -i ./reconstruction/BNLx.liver.transcriptome.08May14.v2 -l "T=PE:O=><:S=AS" -1 ./trimmedReads/BNLX_1_GCCAAT_L005_R1_001_val_1.fq -2 ./trimmedReads/BNLX_1_GCCAAT_L005_R2_001_val_2.fq -p 10 -o ./quantification/sailFish.v2/BNLx1
sailfish quant -i ./reconstruction/BNLx.liver.transcriptome.08May14.v2 -l "T=PE:O=><:S=AS" -1 ./trimmedReads/BNLX_2_CAGATC_L006_R1_001_val_1.fq -2 ./trimmedReads/BNLX_2_CAGATC_L006_R2_001_val_2.fq -p 10 -o ./quantification/sailFish.v2/BNLx2
sailfish quant -i ./reconstruction/BNLx.liver.transcriptome.08May14.v2 -l "T=PE:O=><:S=AS" -1 ./trimmedReads/BNLX_3_CTTGTA_L007_R1_001_val_1.fq -2 ./trimmedReads/BNLX_3_CTTGTA_L007_R2_001_val_2.fq -p 10 -o ./quantification/sailFish.v2/BNLx3

```

```{r}
rm(list=ls())
options(stringsAsFactors=FALSE)
setwd("/Volumes/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD/")
BNLx1.count = read.table(file="quantification/sailFish.v2/BNLx1/quant_bias_corrected.sf",sep="\t",header=FALSE)
BNLx2.count = read.table(file="quantification/sailFish.v2/BNLx2/quant_bias_corrected.sf",sep="\t",header=FALSE)
BNLx3.count = read.table(file="quantification/sailFish.v2/BNLx3/quant_bias_corrected.sf",sep="\t",header=FALSE)

colnames(BNLx1.count) = c("transcript_id","length",paste("BNLx1",c("TPM","RPKM","KPKM","EstNumKmers","EstNumReads"),sep="."))
colnames(BNLx2.count) = c("transcript_id","length",paste("BNLx2",c("TPM","RPKM","KPKM","EstNumKmers","EstNumReads"),sep="."))
colnames(BNLx3.count) = c("transcript_id","length",paste("BNLx3",c("TPM","RPKM","KPKM","EstNumKmers","EstNumReads"),sep="."))

counts = merge(BNLx1.count,BNLx2.count,by=c("transcript_id","length"))
counts = merge(counts,BNLx3.count,by=c("transcript_id","length"))

counts$numSamplesGrt1 = rowSums(counts[,grep("TPM",colnames(counts))]>1)
counts = counts[counts$numSamplesGrt1!=0,]

counts$gene_id = paste("polyA",unlist(lapply(strsplit(counts$transcript_id,split=".",fixed=TRUE),function(a) a[2])),sep=".")

counts$sumTPM = rowSums(counts[,grep("TPM",colnames(counts))])
counts = counts[order(counts$gene_id,counts$sumTPM,decreasing=TRUE),]

## rename transcripts based on FPKM  ##
newID = data.frame(do.call(rbind,aggregate(counts$transcript_id,by=list(gene_id=counts$gene_id),function(a) cbind(a,paste("total",strsplit(a,split=".",fixed=TRUE)[[1]][2],1:length(a),sep=".")))$x))
colnames(newID) = c("transcript_id","transcript_id.new")

##  reduce GTF file  ##
orig.gtf = read.table(file="reconstruction/BNLx.Liver.08May14.v2.gtf",header=FALSE,sep="\t")
orig.gtf$transcript_id = unlist(lapply(strsplit(orig.gtf$V9,split="; "),function(a) gsub(";","",gsub("transcript_id ","",a[grep("transcript",a)]))))
orig.gtf$gene_id = unlist(lapply(strsplit(orig.gtf$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))

new.gtf = merge(orig.gtf,newID,by="transcript_id")
new.gtf$V9 = paste('gene_id "',new.gtf$gene_id,'"; transcript_id "',new.gtf$transcript_id.new,'";',sep="")
write.table(new.gtf[,paste("V",c(1:9),sep="")],file="reconstruction/BNLx.Liver.08May14.v3.gtf",row.names=FALSE,col.names=FALSE,quote=FALSE,sep="\t")
```


##  Requantify - VERSION 3

# generate fasta file of transcript sequences
cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD/reconstruction
gffread -w BNLx.Liver.08May14.v3.fa -g /data/Tabastore3/LauraS/index/rn5_wSpikes.fa BNLx.Liver.08May14.v3.gtf
```

### Quantify Using SailFish

```
export LD_LIBRARY_PATH=/usr/local/sailfish/lib:$LD_LIBRARY_PATH
export PATH=/usr/local/sailfish/bin:$PATH
cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD/reconstruction
sailfish index -t BNLx.Liver.08May14.v3.fa -k 20 -p 5 -o BNLx.liver.transcriptome.08May14.v3

cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD
mkdir ./quantification/sailFish.v3
sailfish quant -i ./reconstruction/BNLx.liver.transcriptome.08May14.v3 -l "T=PE:O=><:S=AS" -1 ./trimmedReads/BNLX_1_GCCAAT_L005_R1_001_val_1.fq -2 ./trimmedReads/BNLX_1_GCCAAT_L005_R2_001_val_2.fq -p 10 -o ./quantification/sailFish.v3/BNLx1
sailfish quant -i ./reconstruction/BNLx.liver.transcriptome.08May14.v3 -l "T=PE:O=><:S=AS" -1 ./trimmedReads/BNLX_2_CAGATC_L006_R1_001_val_1.fq -2 ./trimmedReads/BNLX_2_CAGATC_L006_R2_001_val_2.fq -p 10 -o ./quantification/sailFish.v3/BNLx2
sailfish quant -i ./reconstruction/BNLx.liver.transcriptome.08May14.v3 -l "T=PE:O=><:S=AS" -1 ./trimmedReads/BNLX_3_CTTGTA_L007_R1_001_val_1.fq -2 ./trimmedReads/BNLX_3_CTTGTA_L007_R2_001_val_2.fq -p 10 -o ./quantification/sailFish.v3/BNLx3

```

```{r}
rm(list=ls())
options(stringsAsFactors=FALSE)
setwd("/Volumes/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD/")
BNLx1.count = read.table(file="quantification/sailFish.v3/BNLx1/quant_bias_corrected.sf",sep="\t",header=FALSE)
BNLx2.count = read.table(file="quantification/sailFish.v3/BNLx2/quant_bias_corrected.sf",sep="\t",header=FALSE)
BNLx3.count = read.table(file="quantification/sailFish.v3/BNLx3/quant_bias_corrected.sf",sep="\t",header=FALSE)

colnames(BNLx1.count) = c("transcript_id","length",paste("BNLx1",c("TPM","RPKM","KPKM","EstNumKmers","EstNumReads"),sep="."))
colnames(BNLx2.count) = c("transcript_id","length",paste("BNLx2",c("TPM","RPKM","KPKM","EstNumKmers","EstNumReads"),sep="."))
colnames(BNLx3.count) = c("transcript_id","length",paste("BNLx3",c("TPM","RPKM","KPKM","EstNumKmers","EstNumReads"),sep="."))

counts = merge(BNLx1.count,BNLx2.count,by=c("transcript_id","length"))
counts = merge(counts,BNLx3.count,by=c("transcript_id","length"))

counts$numSamplesGrt1 = rowSums(counts[,grep("TPM",colnames(counts))]>1)
counts = counts[counts$numSamplesGrt1!=0,]

counts$gene_id = paste("total",unlist(lapply(strsplit(counts$transcript_id,split=".",fixed=TRUE),function(a) a[2])),sep=".")

counts$sumTPM = rowSums(counts[,grep("TPM",colnames(counts))])
counts = counts[order(counts$gene_id,counts$sumTPM,decreasing=TRUE),]

## rename transcripts based on FPKM  ##
newID = data.frame(do.call(rbind,aggregate(counts$transcript_id,by=list(gene_id=counts$gene_id),function(a) cbind(a,paste("total",strsplit(a,split=".",fixed=TRUE)[[1]][2],1:length(a),sep=".")))$x))
colnames(newID) = c("transcript_id","transcript_id.new")

##  reduce GTF file  ##
orig.gtf = read.table(file="reconstruction/BNLx.Liver.08May14.v3.gtf",header=FALSE,sep="\t")
orig.gtf$transcript_id = unlist(lapply(strsplit(orig.gtf$V9,split="; "),function(a) gsub(";","",gsub("transcript_id ","",a[grep("transcript",a)]))))
orig.gtf$gene_id = unlist(lapply(strsplit(orig.gtf$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))

new.gtf = merge(orig.gtf,newID,by="transcript_id")
new.gtf$V9 = paste('gene_id "',new.gtf$gene_id,'"; transcript_id "',new.gtf$transcript_id.new,'";',sep="")
write.table(new.gtf[,paste("V",c(1:9),sep="")],file="reconstruction/BNLx.Liver.08May14.v4.gtf",row.names=FALSE,col.names=FALSE,quote=FALSE,sep="\t")
```


##  Requantify - VERSION 4

# generate fasta file of transcript sequences
cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD/reconstruction
gffread -w BNLx.Liver.08May14.v4.fa -g /data/Tabastore3/LauraS/index/rn5_wSpikes.fa BNLx.Liver.08May14.v4.gtf
```

### Quantify Using SailFish

```
export LD_LIBRARY_PATH=/usr/local/sailfish/lib:$LD_LIBRARY_PATH
export PATH=/usr/local/sailfish/bin:$PATH
cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD/reconstruction
sailfish index -t BNLx.Liver.08May14.v4.fa -k 20 -p 5 -o BNLx.liver.transcriptome.08May14.v4

cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD
mkdir ./quantification/sailFish.v4
sailfish quant -i ./reconstruction/BNLx.liver.transcriptome.08May14.v4 -l "T=PE:O=><:S=AS" -1 ./trimmedReads/BNLX_1_GCCAAT_L005_R1_001_val_1.fq -2 ./trimmedReads/BNLX_1_GCCAAT_L005_R2_001_val_2.fq -p 10 -o ./quantification/sailFish.v4/BNLx1
sailfish quant -i ./reconstruction/BNLx.liver.transcriptome.08May14.v4 -l "T=PE:O=><:S=AS" -1 ./trimmedReads/BNLX_2_CAGATC_L006_R1_001_val_1.fq -2 ./trimmedReads/BNLX_2_CAGATC_L006_R2_001_val_2.fq -p 10 -o ./quantification/sailFish.v4/BNLx2
sailfish quant -i ./reconstruction/BNLx.liver.transcriptome.08May14.v4 -l "T=PE:O=><:S=AS" -1 ./trimmedReads/BNLX_3_CTTGTA_L007_R1_001_val_1.fq -2 ./trimmedReads/BNLX_3_CTTGTA_L007_R2_001_val_2.fq -p 10 -o ./quantification/sailFish.v4/BNLx3

```

```{r}
rm(list=ls())
options(stringsAsFactors=FALSE)
setwd("/Volumes/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD/")
BNLx1.count = read.table(file="quantification/sailFish.v4/BNLx1/quant_bias_corrected.sf",sep="\t",header=FALSE)
BNLx2.count = read.table(file="quantification/sailFish.v4/BNLx2/quant_bias_corrected.sf",sep="\t",header=FALSE)
BNLx3.count = read.table(file="quantification/sailFish.v4/BNLx3/quant_bias_corrected.sf",sep="\t",header=FALSE)

colnames(BNLx1.count) = c("transcript_id","length",paste("BNLx1",c("TPM","RPKM","KPKM","EstNumKmers","EstNumReads"),sep="."))
colnames(BNLx2.count) = c("transcript_id","length",paste("BNLx2",c("TPM","RPKM","KPKM","EstNumKmers","EstNumReads"),sep="."))
colnames(BNLx3.count) = c("transcript_id","length",paste("BNLx3",c("TPM","RPKM","KPKM","EstNumKmers","EstNumReads"),sep="."))

counts = merge(BNLx1.count,BNLx2.count,by=c("transcript_id","length"))
counts = merge(counts,BNLx3.count,by=c("transcript_id","length"))

counts$numSamplesGrt1 = rowSums(counts[,grep("TPM",colnames(counts))]>1)
counts = counts[counts$numSamplesGrt1!=0,]

counts$gene_id = paste("total",unlist(lapply(strsplit(counts$transcript_id,split=".",fixed=TRUE),function(a) a[2])),sep=".")

counts$sumTPM = rowSums(counts[,grep("TPM",colnames(counts))])
counts = counts[order(counts$gene_id,counts$sumTPM,decreasing=TRUE),]

## rename transcripts based on FPKM  ##
newID = data.frame(do.call(rbind,aggregate(counts$transcript_id,by=list(gene_id=counts$gene_id),function(a) cbind(a,paste("total",strsplit(a,split=".",fixed=TRUE)[[1]][2],1:length(a),sep=".")))$x))
colnames(newID) = c("transcript_id","transcript_id.new")

##  reduce GTF file  ##
orig.gtf = read.table(file="reconstruction/BNLx.Liver.08May14.v4.gtf",header=FALSE,sep="\t")
orig.gtf$transcript_id = unlist(lapply(strsplit(orig.gtf$V9,split="; "),function(a) gsub(";","",gsub("transcript_id ","",a[grep("transcript",a)]))))
orig.gtf$gene_id = unlist(lapply(strsplit(orig.gtf$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))

new.gtf = merge(orig.gtf,newID,by="transcript_id")
new.gtf$V9 = paste('gene_id "',new.gtf$gene_id,'"; transcript_id "',new.gtf$transcript_id.new,'";',sep="")
write.table(new.gtf[,paste("V",c(1:9),sep="")],file="reconstruction/BNLx.Liver.08May14.v5.gtf",row.names=FALSE,col.names=FALSE,quote=FALSE,sep="\t")
```

##  Requantify - VERSION 5

# generate fasta file of transcript sequences
cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD/reconstruction
gffread -w BNLx.Liver.08May14.v5.fa -g /data/Tabastore3/LauraS/index/rn5_wSpikes.fa BNLx.Liver.08May14.v5.gtf

export LD_LIBRARY_PATH=/usr/local/sailfish/lib:$LD_LIBRARY_PATH
export PATH=/usr/local/sailfish/bin:$PATH
cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD/reconstruction
sailfish index -t BNLx.Liver.08May14.v5.fa -k 20 -p 5 -o BNLx.liver.transcriptome.08May14.v5

cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD
mkdir ./quantification/sailFish.v5
sailfish quant -i ./reconstruction/BNLx.liver.transcriptome.08May14.v5 -l "T=PE:O=><:S=AS" -1 ./trimmedReads/BNLX_1_GCCAAT_L005_R1_001_val_1.fq -2 ./trimmedReads/BNLX_1_GCCAAT_L005_R2_001_val_2.fq -p 10 -o ./quantification/sailFish.v5/BNLx1
sailfish quant -i ./reconstruction/BNLx.liver.transcriptome.08May14.v5 -l "T=PE:O=><:S=AS" -1 ./trimmedReads/BNLX_2_CAGATC_L006_R1_001_val_1.fq -2 ./trimmedReads/BNLX_2_CAGATC_L006_R2_001_val_2.fq -p 10 -o ./quantification/sailFish.v5/BNLx2
sailfish quant -i ./reconstruction/BNLx.liver.transcriptome.08May14.v5 -l "T=PE:O=><:S=AS" -1 ./trimmedReads/BNLX_3_CTTGTA_L007_R1_001_val_1.fq -2 ./trimmedReads/BNLX_3_CTTGTA_L007_R2_001_val_2.fq -p 10 -o ./quantification/sailFish.v5/BNLx3

```

```{r}

counts$gene_id = paste("total",unlist(lapply(strsplit(counts$transcript_id,split=".",fixed=TRUE),function(a) a[2])),sep=".")

counts$sumTPM = rowSums(counts[,grep("TPM",colnames(counts))])
counts = counts[order(counts$gene_id,counts$sumTPM,decreasing=TRUE),]

## rename transcripts based on FPKM  ##
newID = data.frame(do.call(rbind,aggregate(counts$transcript_id,by=list(gene_id=counts$gene_id),function(a) cbind(a,paste("total",strsplit(a,split=".",fixed=TRUE)[[1]][2],1:length(a),sep=".")))$x))rm(list=ls())
options(stringsAsFactors=FALSE)
setwd("/Volumes/LauraS/BNLx.SHR/RNA-Seq.Liver/totalRNA.UCD/")
BNLx1.count = read.table(file="quantification/sailFish.v5/BNLx1/quant_bias_corrected.sf",sep="\t",header=FALSE)
BNLx2.count = read.table(file="quantification/sailFish.v5/BNLx2/quant_bias_corrected.sf",sep="\t",header=FALSE)
BNLx3.count = read.table(file="quantification/sailFish.v5/BNLx3/quant_bias_corrected.sf",sep="\t",header=FALSE)

colnames(BNLx1.count) = c("transcript_id","length",paste("BNLx1",c("TPM","RPKM","KPKM","EstNumKmers","EstNumReads"),sep="."))
colnames(BNLx2.count) = c("transcript_id","length",paste("BNLx2",c("TPM","RPKM","KPKM","EstNumKmers","EstNumReads"),sep="."))
colnames(BNLx3.count) = c("transcript_id","length",paste("BNLx3",c("TPM","RPKM","KPKM","EstNumKmers","EstNumReads"),sep="."))

counts = merge(BNLx1.count,BNLx2.count,by=c("transcript_id","length"))
counts = merge(counts,BNLx3.count,by=c("transcript_id","length"))

counts$numSamplesGrt1 = rowSums(counts[,grep("TPM",colnames(counts))]>1)
counts = counts[counts$numSamplesGrt1!=0,]

orig.gtf = read.table(file="reconstruction/BNLx.Liver.08May14.v5.gtf",header=FALSE,sep="\t")
new.gtf = orig.gtf[!grepl("ERCC",orig.gtf$V1),]
write.table(new.gtf[,paste("V",c(1:9),sep="")],file="reconstruction/BNLx.Liver.08May14.FINAL.gtf",row.names=FALSE,col.names=FALSE,quote=FALSE,sep="\t")
```


















export PATH=$HOME/bin:$PATH
export PYTHONPATH=$HOME/bin:$PYTHONPATH

cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.alignedReads
cufflinks -u --seed 5464 -G /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/transcript.polyA.24Mar14.gtf -p 4 -o /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/BNLx.polyA.fpkm BNLx.polyA.bam
cufflinks -u --seed 5465 -G /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/transcript.polyA.24Mar14.gtf -p 4 -o /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/SHR.polyA.fpkm SHR.polyA.bam
```

8.  After re-quantifying with new GTF, eliminate transcripts with less than 1 FPKM in both strains and rename transcripts based on their combined (across strains) FPKM value, i.e., the transcript label '.1' is the major transcript
--------------------------------------------------

```{r,eval=FALSE}
BNLx.count = read.table(file="polyA/polyA.reconstruction/BNLx.polyA.fpkm/transcripts.gtf",sep="\t",header=FALSE)
BNLx.count = BNLx.count[BNLx.count$V3=="transcript",]
BNLx.count$transcript_id = unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript",a)])))
BNLx.count$gene_id = unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))
BNLx.count$BNLx.fpkm = as.numeric(unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))


SHR.count = read.table(file="polyA/polyA.reconstruction/SHR.polyA.fpkm/transcripts.gtf",sep="\t",header=FALSE)
SHR.count = SHR.count[SHR.count$V3=="transcript",]
SHR.count$transcript_id = unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript",a)])))
SHR.count$gene_id = unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))
SHR.count$SHR.fpkm = as.numeric(unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))

counts = merge(BNLx.count,SHR.count,by=c("gene_id","transcript_id"))
counts$sumFPKM = counts$BNLx.fpkm+counts$SHR.fpkm
counts = counts[counts$BNLx.fpkm>1 | counts$SHR.fpkm>1,c("gene_id","transcript_id","BNLx.fpkm","SHR.fpkm","sumFPKM")]
counts = counts[order(counts$gene_id,counts$sumFPKM,decreasing=TRUE),]

## rename transcripts based on FPKM  ##
newID = data.frame(do.call(rbind,aggregate(counts$transcript_id,by=list(gene_id=counts$gene_id),function(a) cbind(a,paste("polyA",strsplit(a,split=".",fixed=TRUE)[[1]][2],1:length(a),sep=".")))$x))
colnames(newID) = c("transcript_id","transcript_id.new")

##  reduce GTF file  ##
orig.gtf = read.table(file="polyA/polyA.reconstruction/transcript.polyA.24Mar14.gtf",header=FALSE,sep="\t")
orig.gtf$transcript_id = unlist(lapply(strsplit(orig.gtf$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript",a)])))
orig.gtf$gene_id = unlist(lapply(strsplit(orig.gtf$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))

new.gtf = merge(orig.gtf,newID,by="transcript_id")
new.gtf$V9 = paste('gene_id "',new.gtf$gene_id,'"; transcript_id "',new.gtf$transcript_id.new,'";',sep="")
write.table(new.gtf[,paste("V",c(1:9),sep="")],file="polyA/polyA.reconstruction/transcript.polyA.reduced.24Mar14.gtf",row.names=FALSE,col.names=FALSE,quote=FALSE,sep="\t")
```

9.  Re-quantify again based on reduced GTF
----------------------------------

```
export PATH=$HOME/bin:$PATH
export PYTHONPATH=$HOME/bin:$PYTHONPATH

cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.alignedReads

cufflinks -u --seed 5466 -G /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/transcript.polyA.reduced.24Mar14.gtf -p 4 -o /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/BNLx.polyA.reduced.fpkm BNLx.polyA.bam

cufflinks -u --seed 5467 -G /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/transcript.polyA.reduced.24Mar14.gtf -p 4 -o /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/SHR.polyA.reduced.fpkm SHR.polyA.bam

```


10.  After re-quantifying with new GTF, eliminate transcripts with less than 1 FPKM in both strains and rename transcripts based on their combined (across strains) FPKM value, i.e., the transcript label '.1' is the major transcript
--------------------------------------------------

```{r,eval=FALSE}
rm(list=ls())
options(stringsAsFactors=FALSE)

BNLx.count = read.table(file="polyA/polyA.reconstruction/BNLx.polyA.reduced.fpkm/transcripts.gtf",sep="\t",header=FALSE)
BNLx.count = BNLx.count[BNLx.count$V3=="transcript",]
BNLx.count$transcript_id = unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript",a)])))
BNLx.count$gene_id = unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))
BNLx.count$BNLx.fpkm = as.numeric(unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))


SHR.count = read.table(file="polyA/polyA.reconstruction/SHR.polyA.reduced.fpkm/transcripts.gtf",sep="\t",header=FALSE)
SHR.count = SHR.count[SHR.count$V3=="transcript",]
SHR.count$transcript_id = unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript",a)])))
SHR.count$gene_id = unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))
SHR.count$SHR.fpkm = as.numeric(unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))

counts = merge(BNLx.count,SHR.count,by=c("gene_id","transcript_id"))
counts$sumFPKM = counts$BNLx.fpkm+counts$SHR.fpkm
counts = counts[counts$BNLx.fpkm>1 | counts$SHR.fpkm>1,c("gene_id","transcript_id","BNLx.fpkm","SHR.fpkm","sumFPKM")]
counts = counts[order(counts$gene_id,counts$sumFPKM,decreasing=TRUE),]

## rename transcripts based on FPKM  ##
newID = data.frame(do.call(rbind,aggregate(counts$transcript_id,by=list(gene_id=counts$gene_id),function(a) cbind(a,paste("polyA",strsplit(a,split=".",fixed=TRUE)[[1]][2],1:length(a),sep=".")))$x))
colnames(newID) = c("transcript_id","transcript_id.new")

##  reduce GTF file  ##
orig.gtf = read.table(file="polyA/polyA.reconstruction/transcript.polyA.reduced.24Mar14.gtf",header=FALSE,sep="\t")
orig.gtf$transcript_id = unlist(lapply(strsplit(orig.gtf$V9,split=";"),function(a) gsub(" transcript_id ","",a[grep("transcript",a)])))
orig.gtf$gene_id = unlist(lapply(strsplit(orig.gtf$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))

new.gtf = merge(orig.gtf,newID,by="transcript_id")
new.gtf$V9 = paste('gene_id "',new.gtf$gene_id,'"; transcript_id "',new.gtf$transcript_id.new,'";',sep="")
write.table(new.gtf[,paste("V",c(1:9),sep="")],file="polyA/polyA.reconstruction/transcript.polyA.reduced.v2.25Mar14.gtf",row.names=FALSE,col.names=FALSE,quote=FALSE,sep="\t")
```



11.  Re-quantify again based on reduced GTF
----------------------------------

```
export PATH=$HOME/bin:$PATH
export PYTHONPATH=$HOME/bin:$PYTHONPATH

cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.alignedReads

cufflinks -u --seed 5468 -G /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/transcript.polyA.reduced.v2.25Mar14.gtf -p 4 -o /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/BNLx.polyA.reduced.v2.fpkm BNLx.polyA.bam

cufflinks -u --seed 5469 -G /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/transcript.polyA.reduced.v2.25Mar14.gtf -p 4 -o /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/SHR.polyA.reduced.v2.fpkm SHR.polyA.bam

```

12. After re-quantifying with new GTF, eliminate transcripts with less than 1 FPKM in both strains and rename transcripts based on their combined (across strains) FPKM value, i.e., the transcript label '.1' is the major transcript
--------------------------------------------------

```{r,eval=FALSE}
BNLx.count = read.table(file="polyA/polyA.reconstruction/BNLx.polyA.reduced.v2.fpkm/transcripts.gtf",sep="\t",header=FALSE)
BNLx.count = BNLx.count[BNLx.count$V3=="transcript",]
BNLx.count$transcript_id = unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript",a)])))
BNLx.count$gene_id = unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))
BNLx.count$BNLx.fpkm = as.numeric(unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))


SHR.count = read.table(file="polyA/polyA.reconstruction/SHR.polyA.reduced.v2.fpkm/transcripts.gtf",sep="\t",header=FALSE)
SHR.count = SHR.count[SHR.count$V3=="transcript",]
SHR.count$transcript_id = unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript",a)])))
SHR.count$gene_id = unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))
SHR.count$SHR.fpkm = as.numeric(unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))

counts = merge(BNLx.count,SHR.count,by=c("gene_id","transcript_id"))
counts$sumFPKM = counts$BNLx.fpkm+counts$SHR.fpkm

sum(counts$BNLx.fpkm<1 & counts$SHR.fpkm<1)
sum(counts$sumFPKM<1)
counts[counts$BNLx.fpkm<1 & counts$SHR.fpkm<1,]

counts = counts[counts$BNLx.fpkm>1 | counts$SHR.fpkm>1,c("gene_id","transcript_id","BNLx.fpkm","SHR.fpkm","sumFPKM")]
counts = counts[order(counts$gene_id,counts$sumFPKM,decreasing=TRUE),]

## rename transcripts based on FPKM  ##
newID = data.frame(do.call(rbind,aggregate(counts$transcript_id,by=list(gene_id=counts$gene_id),function(a) cbind(a,paste("polyA",strsplit(a,split=".",fixed=TRUE)[[1]][2],1:length(a),sep=".")))$x))
colnames(newID) = c("transcript_id","transcript_id.new")

##  reduce GTF file  ##
orig.gtf = read.table(file="polyA/polyA.reconstruction/transcript.polyA.reduced.v2.25Mar14.gtf",header=FALSE,sep="\t")
orig.gtf$transcript_id = unlist(lapply(strsplit(orig.gtf$V9,split=";"),function(a) gsub(" transcript_id ","",a[grep("transcript",a)])))
orig.gtf$gene_id = unlist(lapply(strsplit(orig.gtf$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))

new.gtf = merge(orig.gtf,newID,by="transcript_id")
new.gtf$V9 = paste('gene_id "',new.gtf$gene_id,'"; transcript_id "',new.gtf$transcript_id.new,'";',sep="")
write.table(new.gtf[,paste("V",c(1:9),sep="")],file="polyA/polyA.reconstruction/transcript.polyA.reduced.v3.25Mar14.gtf",row.names=FALSE,col.names=FALSE,quote=FALSE,sep="\t")
```

13.  Re-quantify again based on reduced GTF
----------------------------------

```
export PATH=$HOME/bin:$PATH
export PYTHONPATH=$HOME/bin:$PYTHONPATH

cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.alignedReads

cufflinks -u --seed 5468 -G /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/transcript.polyA.reduced.v3.25Mar14.gtf -p 4 -o /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/BNLx.polyA.reduced.v3.fpkm BNLx.polyA.bam

cufflinks -u --seed 5469 -G /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/transcript.polyA.reduced.v3.25Mar14.gtf -p 4 -o /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/SHR.polyA.reduced.v3.fpkm SHR.polyA.bam

```

14. After re-quantifying with new GTF, eliminate transcripts with less than 1 FPKM in both strains and rename transcripts based on their combined (across strains) FPKM value, i.e., the transcript label '.1' is the major transcript
--------------------------------------------------

```{r,eval=FALSE}
BNLx.count = read.table(file="polyA/polyA.reconstruction/BNLx.polyA.reduced.v3.fpkm/transcripts.gtf",sep="\t",header=FALSE)
BNLx.count = BNLx.count[BNLx.count$V3=="transcript",]
BNLx.count$transcript_id = unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript",a)])))
BNLx.count$gene_id = unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))
BNLx.count$BNLx.fpkm = as.numeric(unlist(lapply(strsplit(BNLx.count$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))


SHR.count = read.table(file="polyA/polyA.reconstruction/SHR.polyA.reduced.v3.fpkm/transcripts.gtf",sep="\t",header=FALSE)
SHR.count = SHR.count[SHR.count$V3=="transcript",]
SHR.count$transcript_id = unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("transcript_id ","",a[grep("transcript",a)])))
SHR.count$gene_id = unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("gene_id ","",a[grep("gene",a)])))
SHR.count$SHR.fpkm = as.numeric(unlist(lapply(strsplit(SHR.count$V9,split="; "),function(a) gsub("FPKM ","",a[grep("FPKM",a)]))))

counts = merge(BNLx.count,SHR.count,by=c("gene_id","transcript_id"))
counts$sumFPKM = counts$BNLx.fpkm+counts$SHR.fpkm

sum(counts$BNLx.fpkm<1 & counts$SHR.fpkm<1)
sum(counts$sumFPKM<1)
```

ALL TRANSCRIPTS WITH FPKM>1 IN AT LEAST ONE STRAIN

cd /data/Tabastore3/LauraS/BNLx.SHR/RNA-Seq/polyA/polyA.reconstruction/
mv transcript.polyA.reduced.v3.25Mar14.gtf transcript.polyA.clean.26Mar14.gtf
mv BNLx.polyA.reduced.v3.fpkm BNLx.polyA.cleaned.fpkm
mv SHR.polyA.reduced.v3.fpkm SHR.polyA.cleaned.fpkm

rm transcript.polyA.reduced.*
rm BNLx.polyA.reduced.*/*
rm SHR.polyA.reduced.*/*
rmdir BNLx.polyA.reduced.*
rmdir SHR.polyA.reduced.*
